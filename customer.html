<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Customer Purchase History</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #4e73df;
            --success-color: #1cc88a;
            --warning-color: #f6c23e;
            --danger-color: #e74a3b;
            --light-bg: #f8f9fc;
        }
        
        body {
            background-color: var(--light-bg);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: #333;
        }
        
        .navbar {
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        
        .card {
            border: none;
            border-radius: 0.5rem;
            box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15);
            margin-bottom: 1.5rem;
        }
        
        .card-header {
            background-color: #f8f9fc;
            border-bottom: 1px solid #e3e6f0;
            font-weight: 700;
            padding: 0.75rem 1.25rem;
        }
        
        .customer-card {
            transition: transform 0.3s, box-shadow 0.3s;
            cursor: pointer;
        }
        
        .customer-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 0.5rem 2rem rgba(0, 0, 0, 0.15);
        }
        
        .customer-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background-color: var(--primary-color);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 1.5rem;
        }
        
        .total-amount {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--primary-color);
        }
        
        .purchase-item {
            border-bottom: 1px solid #eee;
            padding: 15px 0;
        }
        
        .purchase-item:last-child {
            border-bottom: none;
        }
        
        .status-badge {
            font-size: 0.8rem;
            padding: 5px 10px;
            border-radius: 20px;
        }
        
        .receipt {
            font-family: 'Courier New', monospace;
            background: white;
            padding: 20px;
            border: 1px dashed #ccc;
        }
        
        .hero-section {
            background: linear-gradient(135deg, var(--primary-color) 0%, #2a4cb3 100%);
            color: white;
            padding: 60px 0;
            border-radius: 0 0 20px 20px;
            margin-bottom: 30px;
        }
        
        .search-box {
            max-width: 500px;
            margin: 0 auto;
        }
        
        .customer-link {
            color: var(--primary-color);
            text-decoration: none;
            font-weight: 500;
        }
        
        .customer-link:hover {
            text-decoration: underline;
        }
        
        .print-section {
            background-color: #f8f9fc;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
        }
        
        @media print {
            .no-print {
                display: none !important;
            }
            
            body {
                background-color: white;
            }
            
            .card {
                box-shadow: none;
                border: 1px solid #ddd;
            }
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark no-print">
        <div class="container">
            <a class="navbar-brand" href="#">
                <i class="fas fa-history me-2"></i>Customer Purchase History
            </a>
            <div class="d-flex">
                <span class="navbar-text me-3">
                    <span class="firebase-status firebase-connected" id="firebase-status"></span>
                    <span id="connection-status">Connected to Firebase</span>
                </span>
            </div>
        </div>
    </nav>

    <!-- Hero Section -->
    <div class="hero-section no-print">
        <div class="container text-center">
            <h1 class="display-4 fw-bold mb-3">Customer Purchase History</h1>
            <p class="lead mb-4">View and manage customer purchase records and payment status</p>
            <div class="search-box">
                <div class="input-group">
                    <input type="text" class="form-control" placeholder="Search customers..." id="customer-search">
                    <button class="btn btn-light" type="button">
                        <i class="fas fa-search"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="container">
        <!-- Customer List -->
        <div class="card no-print">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="m-0">All Customers</h5>
                <span class="badge bg-primary" id="customer-count">0 customers</span>
            </div>
            <div class="card-body">
                <div class="row" id="customers-container">
                    <!-- Customer cards will be populated here -->
                </div>
            </div>
        </div>

        <!-- Individual Customer Details -->
        <div id="customer-details-section">
            <!-- Customer details will be shown here when a customer is selected -->
        </div>
    </div>

    <!-- Bootstrap & jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    
    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBsfInpkC35f2ZIaeKyiysPaHxARizICmk",
            authDomain: "hallow-2c7e6.firebaseapp.com",
            projectId: "hallow-2c7e6",
            storageBucket: "hallow-2c7e6.firebasestorage.app",
            messagingSenderId: "310263322867",
            appId: "1:310263322867:web:3a5338621e8b75c163ff86",
            measurementId: "G-4P4D5W5PSE"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Customer Purchase History Class
        class CustomerPurchaseHistory {
            constructor() {
                this.customers = [];
                this.purchases = [];
                this.selectedCustomer = null;
                
                this.init();
            }
            
            async init() {
                // Load data from Firebase
                await this.loadCustomers();
                await this.loadPurchases();
                
                // Check if we're on a customer-specific page
                this.checkUrlForCustomer();
                
                // Set up event listeners
                this.setupEventListeners();
                
                // Update connection status
                this.updateConnectionStatus();
            }
            
            updateConnectionStatus() {
                document.getElementById('firebase-status').className = 'firebase-status firebase-connected';
                document.getElementById('connection-status').textContent = 'Connected to Firebase';
            }
            
            async loadCustomers() {
                try {
                    const snapshot = await db.collection('customers').get();
                    this.customers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    this.renderCustomers();
                } catch (error) {
                    console.error('Error loading customers:', error);
                }
            }
            
            async loadPurchases() {
                try {
                    const snapshot = await db.collection('purchases').get();
                    this.purchases = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                } catch (error) {
                    console.error('Error loading purchases:', error);
                }
            }
            
            renderCustomers() {
                const container = document.getElementById('customers-container');
                container.innerHTML = '';
                
                // Update customer count
                document.getElementById('customer-count').textContent = `${this.customers.length} customers`;
                
                this.customers.forEach(customer => {
                    // Calculate total purchases for this customer
                    const customerPurchases = this.purchases.filter(p => p.customer_id === customer.id);
                    const total = customerPurchases.reduce((sum, p) => sum + (p.total_amount || 0), 0);
                    const pendingCount = customerPurchases.filter(p => p.status !== 'paid').length;
                    
                    const col = document.createElement('div');
                    col.className = 'col-md-6 col-lg-4 mb-4';
                    col.innerHTML = `
                        <div class="card customer-card h-100" data-id="${customer.id}">
                            <div class="card-body">
                                <div class="d-flex align-items-center mb-3">
                                    <div class="customer-avatar me-3">
                                        ${customer.name.charAt(0).toUpperCase()}
                                    </div>
                                    <div>
                                        <h5 class="card-title mb-0">${customer.name}</h5>
                                        <p class="text-muted mb-0">${customer.phone || 'No phone'}</p>
                                    </div>
                                </div>
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <span>Total Spent:</span>
                                    <span class="total-amount">$${total.toFixed(2)}</span>
                                </div>
                                <div class="d-flex justify-content-between align-items-center">
                                    <span>Pending Payments:</span>
                                    <span class="badge bg-warning">${pendingCount}</span>
                                </div>
                                <hr>
                                <div class="d-grid">
                                    <a href="/customer.html?id=${customer.id}" class="btn btn-outline-primary customer-link">
                                        <i class="fas fa-external-link-alt me-1"></i> View Purchase History
                                    </a>
                                </div>
                            </div>
                        </div>
                    `;
                    container.appendChild(col);
                });
                
                // Add click event to customer cards
                document.querySelectorAll('.customer-card').forEach(card => {
                    card.addEventListener('click', (e) => {
                        // Don't trigger if clicking the link
                        if (!e.target.closest('.customer-link')) {
                            const customerId = card.getAttribute('data-id');
                            this.showCustomerDetails(customerId);
                        }
                    });
                });
            }
            
            checkUrlForCustomer() {
                // Check if URL contains a customer ID parameter
                const urlParams = new URLSearchParams(window.location.search);
                const customerId = urlParams.get('id');
                
                if (customerId) {
                    this.showCustomerDetails(customerId);
                    
                    // Scroll to customer details section
                    setTimeout(() => {
                        document.getElementById('customer-details-section').scrollIntoView({ behavior: 'smooth' });
                    }, 500);
                }
            }
            
            showCustomerDetails(customerId) {
                const customer = this.customers.find(c => c.id === customerId);
                if (!customer) {
                    alert('Customer not found');
                    return;
                }
                
                this.selectedCustomer = customer;
                
                // Get customer's purchases
                const customerPurchases = this.purchases.filter(p => p.customer_id === customerId);
                const totalSpent = customerPurchases.reduce((sum, p) => sum + (p.total_amount || 0), 0);
                const pendingPayments = customerPurchases.filter(p => p.status !== 'paid').length;
                
                let detailsHtml = `
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h4 class="m-0">
                                <i class="fas fa-user me-2"></i>${customer.name}
                            </h4>
                            <div class="d-flex align-items-center">
                                <span class="badge bg-primary me-2">${customerPurchases.length} purchases</span>
                                <button class="btn btn-sm btn-outline-secondary no-print" id="print-customer-btn">
                                    <i class="fas fa-print me-1"></i> Print
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="row mb-4">
                                <div class="col-md-6">
                                    <p><strong><i class="fas fa-phone me-2"></i>Phone:</strong> ${customer.phone || 'N/A'}</p>
                                    <p><strong><i class="fas fa-envelope me-2"></i>Email:</strong> ${customer.email || 'N/A'}</p>
                                </div>
                                <div class="col-md-6">
                                    <p><strong><i class="fas fa-calendar me-2"></i>Member Since:</strong> ${new Date(customer.created_at).toLocaleDateString()}</p>
                                    <p><strong><i class="fas fa-dollar-sign me-2"></i>Total Spent:</strong> $${totalSpent.toFixed(2)}</p>
                                    <p><strong><i class="fas fa-clock me-2"></i>Pending Payments:</strong> ${pendingPayments}</p>
                                </div>
                            </div>
                            
                            <h5 class="mb-3">Purchase History</h5>
                `;
                
                if (customerPurchases.length === 0) {
                    detailsHtml += `
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>No purchase history found for this customer.
                        </div>
                    `;
                } else {
                    // Sort purchases by date (newest first)
                    customerPurchases.sort((a, b) => new Date(b.purchase_date) - new Date(a.purchase_date));
                    
                    detailsHtml += `<div class="list-group">`;
                    
                    customerPurchases.forEach(purchase => {
                        const products = JSON.parse(purchase.product_data || '[]');
                        const productNames = products.map(p => `${p.name} (x${p.quantity})`).join(', ');
                        
                        detailsHtml += `
                            <div class="list-group-item purchase-item">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <h6 class="mb-0">${new Date(purchase.purchase_date).toLocaleDateString()}</h6>
                                    <span class="badge ${purchase.status === 'paid' ? 'bg-success' : 'bg-warning'} status-badge">
                                        ${purchase.status || 'pending'}
                                    </span>
                                </div>
                                <p class="mb-2">${productNames}</p>
                                <div class="d-flex justify-content-between align-items-center">
                                    <span class="text-muted">Transaction #${purchase.id.substring(0, 8)}</span>
                                    <strong>$${purchase.total_amount?.toFixed(2) || '0.00'}</strong>
                                </div>
                            </div>
                        `;
                    });
                    
                    detailsHtml += `</div>`;
                }
                
                detailsHtml += `
                        </div>
                    </div>
                    
                    <div class="print-section no-print mt-4">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6>Share this customer's purchase history:</h6>
                                <p class="mb-0 text-muted">Copy the link below to share this customer's purchase history</p>
                            </div>
                            <button class="btn btn-primary" id="copy-link-btn">
                                <i class="fas fa-copy me-1"></i> Copy Link
                            </button>
                        </div>
                        <div class="mt-2 p-2 bg-light rounded">
                            <code id="customer-link">${window.location.origin}/customer.html?id=${customer.id}</code>
                        </div>
                    </div>
                `;
                
                document.getElementById('customer-details-section').innerHTML = detailsHtml;
                
                // Add event listeners for the new buttons
                document.getElementById('print-customer-btn').addEventListener('click', () => {
                    window.print();
                });
                
                document.getElementById('copy-link-btn').addEventListener('click', () => {
                    const linkText = document.getElementById('customer-link').textContent;
                    navigator.clipboard.writeText(linkText).then(() => {
                        const btn = document.getElementById('copy-link-btn');
                        const originalText = btn.innerHTML;
                        btn.innerHTML = '<i class="fas fa-check me-1"></i> Copied!';
                        setTimeout(() => {
                            btn.innerHTML = originalText;
                        }, 2000);
                    });
                });
            }
            
            setupEventListeners() {
                // Customer search
                document.getElementById('customer-search').addEventListener('input', (e) => {
                    this.filterCustomers(e.target.value);
                });
            }
            
            filterCustomers(searchTerm) {
                const cards = document.querySelectorAll('.customer-card');
                
                cards.forEach(card => {
                    const name = card.querySelector('.card-title').textContent.toLowerCase();
                    const phone = card.querySelector('.text-muted').textContent.toLowerCase();
                    
                    if (name.includes(searchTerm.toLowerCase()) || phone.includes(searchTerm.toLowerCase())) {
                        card.closest('.col-md-6').style.display = '';
                    } else {
                        card.closest('.col-md-6').style.display = 'none';
                    }
                });
            }
        }

        // Initialize the system when the page loads
        document.addEventListener('DOMContentLoaded', () => {
            window.customerHistory = new CustomerPurchaseHistory();
        });
    </script>
</body>
</html>
